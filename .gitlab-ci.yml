include:
  - template: 'Workflows/MergeRequest-Pipelines.gitlab-ci.yml'

stages:
  - setup
  - test

variables:
  GIT_DEPTH: 0
  NX_BRANCH: $CI_COMMIT_BRANCH
  NX_RUN_GROUP: $CI_PIPELINE_ID
  NX_CLOUD_ACCESS_TOKEN: $NX_CLOUD_AUTH_TOKEN
  NX_CLOUD_DISTRIBUTED_EXECUTION: 'true'
  PRISMA_HIDE_UPDATE_MESSAGE: 'true'

.node-job:
  image: node:16.3.0
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - .npm/
    policy: pull
  before_script:
    - npm ci --cache .npm --prefer-offline

.base-head-rules:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: delayed
      start_in: 15 seconds
      variables:
        NX_BASE: remotes/origin/${CI_DEFAULT_BRANCH}~1
        # NX_HEAD: remotes/origin/${CI_DEFAULT_BRANCH}
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      when: delayed
      start_in: 15 seconds
      variables:
        NX_BASE: remotes/origin/${CI_MERGE_REQUEST_TARGET_BRANCH_NAME}
        # NX_HEAD: HEAD

.require-setup:
  needs:
    - job: setup
      optional: true

setup:
  stage: setup
  extends: [.node-job]
  cache:
    key: !reference [.node-job, cache, key]
    paths: !reference [.node-job, cache, paths]
    policy: pull-push
  script:
    - echo "Done!..."
  rules:
    - changes:
        - package-lock.json

agent:
  stage: test
  extends: [.node-job, .require-setup]
  parallel: 2
  image: ghcr.io/gperdomor/nx-docker:16.2-alpine
  services:
    - docker:20.10.7-dind
  script:
    - npx @nrwl/nx-cloud start-agent

verify-mr:
  extends: [.node-job, .base-head-rules, .require-setup]
  stage: test
  script:
    - npx nx affected --target=build --parallel --base=$NX_BASE
    - npx nx affected --target=lint --parallel --base=$NX_BASE
    - npx nx affected --target=test --parallel --base=$NX_BASE
    - npx nx affected --target=e2e --parallel --base=$NX_BASE
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  after_script:
    - npx @nrwl/nx-cloud stop-all-agents
