import { existsSync, readFileSync } from 'node:fs';

async function checkLockFiles() {
  const errors = [];
  if (existsSync('yarn.lock')) {
    errors.push('Invalid occurence of "yarn.lock" file. Please remove it and use only "package-lock.json"');
  }
  if (existsSync('pnpm-lock.yaml')) {
    errors.push('Invalid occurence of "pnpm-lock.yaml" file. Please remove it and use only "package-lock.json"');
  }
  if (existsSync('bun.lockb')) {
    errors.push('Invalid occurence of "bun.lockb" file. Please remove it and use only "package-lock.json"');
  }
  try {
    const content = readFileSync('package-lock.json', 'utf-8');
    if (content.match(/localhost:487/)) {
      errors.push(
        'The "package-lock.json" has reference to local repository ("localhost:4873"). Please use ensure you disable local registry before running "npm install"'
      );
    }
    if (content.match(/resolution: \{tarball/)) {
      errors.push('The "package-lock.json" has reference to tarball package. Please use npm registry only');
    }

    const { default: packageJson } = await import('../../package-lock.json', { with: { type: 'json' } });

    if (packageJson.lockfileVersion !== 3) {
      errors.push(
        'The "package-lock.json" file was generated by an old npm version. Please use npm 7 or greater and run "npm install" again'
      );
    }
  } catch {
    errors.push('The "package-lock.json" does not exist or cannot be read');
  }
  return errors;
}

console.log('🔒🔒🔒 Validating lock files 🔒🔒🔒\n');
const invalid = await checkLockFiles();

if (invalid.length > 0) {
  invalid.forEach((e) => console.log(e));
  process.exit(1);
} else {
  console.log('Lock file is valid 👍');
  process.exit(0);
}
